<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MC DS | Morse Decoder</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="./icon-512.png">
    <style>
        :root { --primary: #3498db; --bg: #1a1a1a; --text: #ecf0f1; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); text-align: center; margin: 0; padding: 20px; touch-action: manipulation; }
        .container { max-width: 600px; margin: 0 auto; }
        .display-box { background: #2c3e50; padding: 20px; border-radius: 10px; margin: 20px 0; min-height: 100px; font-size: 28px; word-wrap: break-word; border: 2px solid var(--primary); color: #fff; text-shadow: 1px 1px 2px black; }
        .buffer { color: #f1c40f; font-family: monospace; height: 30px; margin-bottom: 10px; font-size: 22px; font-weight: bold; }
        button { background: var(--primary); color: white; border: none; padding: 15px 30px; border-radius: 50px; font-size: 18px; cursor: pointer; transition: 0.3s; margin: 10px; width: 80%; max-width: 300px; font-weight: bold; }
        button:active { transform: scale(0.95); opacity: 0.8; }
        .slider-container { margin: 30px 0; background: #333; padding: 15px; border-radius: 10px; }
        input[type=range] { width: 90%; height: 15px; border-radius: 5px; appearance: none; background: #555; cursor: pointer; }
        footer { margin-top: 50px; font-size: 14px; opacity: 0.7; border-top: 1px solid #444; padding-top: 20px; line-height: 1.6; }
        .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .active-dot { background-color: #27ae60; box-shadow: 0 0 8px #27ae60; }
    </style>
</head>
<body>

<div class="container">
    <h1>MC DS</h1>
    <div class="buffer" id="bufferDisplay">READY</div>
    <div class="display-box" id="output">TEXT WILL APPEAR HERE</div>
    
    <button id="startBtn" onclick="startMic()">START MICROPHONE</button>
    
    <div class="slider-container">
        <label>Sensitivity (Slide right for loud rooms)</label><br><br>
        <input type="range" id="threshold" min="0.005" max="0.2" step="0.005" value="0.03">
    </div>

    <button onmousedown="startTone()" onmouseup="stopTone()" ontouchstart="startTone()" ontouchend="stopTone()" style="background: #8e44ad;">SEND MANUAL TONE</button>

    <footer>
        <div id="statusIndicator"><span class="status-dot" id="dot"></span> <span id="statusText">Microphone: Off</span></div>
        Â© 2026 Created & Owned by <strong>Exequiel Estrada</strong><br>
        <em>Mangaldan, Philippines</em>
    </footer>
</div>

<script>
    let audioContext = new (window.AudioContext || window.webkitAudioContext)();
    let analyser = audioContext.createAnalyser();
    analyser.fftSize = 1024; // Faster processing
    let isListening = false;
    let morseBuffer = "";
    let lastState = false;
    let lastTime = Date.now();
    let source;

    const morseCode = { 
        ".-":"A", "-...":"B", "-.-.":"C", "-..":"D", ".":"E", "..-.":"F", "--.":"G", "....":"H", "..":"I", ".---":"J", "-.-":"K", ".-..":"L", "--":"M", "-.":"N", "---":"O", ".--.":"P", "--.-":"Q", ".-.":"R", "...":"S", "-":"T", "..-":"U", "...-":"V", ".--":"W", "-..-":"X", "-.--":"Y", "--..":"Z", 
        "-----":"0", ".----":"1", "..---":"2", "...--":"3", "....-":"4", ".....":"5", "-....":"6", "--...":"7", "---..":"8", "----.":"9", " ":" " 
    };

    async function startMic() {
        const btn = document.getElementById('startBtn');
        const dot = document.getElementById('dot');
        const statusText = document.getElementById('statusText');
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            if (audioContext.state === 'suspended') await audioContext.resume();
            
            source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            
            isListening = true;
            btn.textContent = "LISTENING ACTIVE";
            btn.style.background = "#27ae60";
            dot.classList.add('active-dot');
            statusText.textContent = "Microphone: ON";
            
            update();
        } catch (err) {
            console.error(err);
            alert("Microphone access denied. Please allow mic in browser settings.");
            btn.textContent = "ACCESS DENIED";
            btn.style.background = "#c0392b";
        }
    }

    function update() {
        if (!isListening) return;
        const dataArray = new Float32Array(analyser.frequencyBinCount);
        analyser.getFloatTimeDomainData(dataArray);
        
        let rms = 0;
        for (let i = 0; i < dataArray.length; i++) rms += dataArray[i] * dataArray[i];
        rms = Math.sqrt(rms / dataArray.length);

        const threshold = parseFloat(document.getElementById('threshold').value);
        let currentState = rms > threshold;
        let now = Date.now();
        let duration = now - lastTime;

        if (currentState !== lastState) {
            if (!currentState) { 
                // TIMING TUNING:
                // Dot: 40ms to 250ms
                // Dash: 250ms+
                if (duration > 40 && duration < 250) morseBuffer += ".";
                else if (duration >= 250) morseBuffer += "-";
                
                document.getElementById('bufferDisplay').textContent = morseBuffer;
            }
            lastTime = now;
            lastState = currentState;
        } else if (!currentState && duration > 700 && morseBuffer !== "") {
            // After 0.7 seconds of silence, decode the letter
            decodeBuffer();
        }
        
        requestAnimationFrame(update);
    }

    function decodeBuffer() {
        const char = morseCode[morseBuffer] || "?";
        const output = document.getElementById('output');
        if (output.textContent === "TEXT WILL APPEAR HERE") output.textContent = "";
        
        output.textContent += char;
        morseBuffer = "";
        document.getElementById('bufferDisplay').textContent = "READY";
    }

    // Manual Tone Generator
    let oscillator;
    function startTone() {
        if (audioContext.state === 'suspended') audioContext.resume();
        oscillator = audioContext.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
        oscillator.connect(audioContext.destination);
        oscillator.start();
    }
    function stopTone() {
        if (oscillator) {
            oscillator.stop();
            oscillator.disconnect();
        }
    }

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js');
    }
</script>

</body>
</html>
