<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MC DS | Morse Decoder</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="./icon-512.png">
    <style>
        :root { --primary: #3498db; --bg: #1a1a1a; --text: #ecf0f1; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); text-align: center; margin: 0; padding: 20px; touch-action: manipulation; }
        .container { max-width: 600px; margin: 0 auto; }
        .display-box { background: #2c3e50; padding: 20px; border-radius: 10px; margin: 20px 0; min-height: 100px; font-size: 24px; word-wrap: break-word; border: 2px solid var(--primary); }
        .buffer { color: var(--primary); font-family: monospace; height: 30px; margin-bottom: 10px; font-size: 18px; }
        button { background: var(--primary); color: white; border: none; padding: 15px 30px; border-radius: 50px; font-size: 18px; cursor: pointer; transition: 0.3s; margin: 10px; width: 80%; max-width: 300px; }
        button:active { transform: scale(0.95); opacity: 0.8; }
        .slider-container { margin: 30px 0; }
        input[type=range] { width: 80%; height: 10px; border-radius: 5px; appearance: none; background: #444; }
        footer { margin-top: 50px; font-size: 14px; opacity: 0.7; border-top: 1px solid #444; padding-top: 20px; }
        .license-link { color: var(--primary); cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

<div class="container">
    <h1>MC DS</h1>
    <div class="buffer" id="bufferDisplay">READY</div>
    <div class="display-box" id="output">TEXT WILL APPEAR HERE</div>
    
    <button id="startBtn" onclick="startMic()">START MICROPHONE</button>
    
    <div class="slider-container">
        <label>Sensitivity Threshold</label><br>
        <input type="range" id="threshold" min="0.01" max="0.3" step="0.01" value="0.05">
    </div>

    <button onmousedown="startTone()" onmouseup="stopTone()" ontouchstart="startTone()" ontouchend="stopTone()">SEND MORSE (TONE)</button>

    <footer>
        Â© 2026 Created & Owned by <strong>Exequiel Estrada</strong><br>
        <span class="license-link" onclick="alert('License: Private Property of Exequiel Estrada. All rights reserved.')">View License Information</span>
    </footer>
</div>

<script>
    let audioContext = new (window.AudioContext || window.webkitAudioContext)();
    let analyser = audioContext.createAnalyser();
    analyser.fftSize = 2048;
    let isListening = false;
    let morseBuffer = "";
    let lastState = false;
    let lastTime = Date.now();
    let source;

    const morseCode = { ".-":"A", "-...":"B", "-.-.":"C", "-..":"D", ".":"E", "..-.":"F", "--.":"G", "....":"H", "..":"I", ".---":"J", "-.-":"K", ".-..":"L", "--":"M", "-.":"N", "---":"O", ".--.":"P", "--.-":"Q", ".-.":"R", "...":"S", "-":"T", "..-":"U", "...-":"V", ".--":"W", "-..-":"X", "-.--":"Y", "--..":"Z", "-----":"0", ".----":"1", "..---":"2", "...--":"3", "....-":"4", ".....":"5", "-....":"6", "--...":"7", "---..":"8", "----.":"9", " ":" " };

    async function startMic() {
        const btn = document.getElementById('startBtn');
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            if (audioContext.state === 'suspended') await audioContext.resume();
            source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            isListening = true;
            btn.textContent = "LISTENING ACTIVE";
            btn.style.background = "#27ae60";
            update();
        } catch (err) {
            alert("Mic error. Please enable permissions in browser settings.");
            btn.textContent = "MIC ERROR";
            btn.style.background = "#c0392b";
        }
    }

    function update() {
        if (!isListening) return;
        const dataArray = new Float32Array(analyser.frequencyBinCount);
        analyser.getFloatTimeDomainData(dataArray);
        
        let rms = 0;
        for (let i = 0; i < dataArray.length; i++) rms += dataArray[i] * dataArray[i];
        rms = Math.sqrt(rms / dataArray.length);

        const threshold = document.getElementById('threshold').value;
        let currentState = rms > threshold;
        let now = Date.now();
        let duration = now - lastTime;

        if (currentState !== lastState) {
            if (!currentState) { // Sound just stopped (End of a dot or dash)
                if (duration > 30 && duration < 200) morseBuffer += "."; 
                else if (duration >= 200) morseBuffer += "-";            
                document.getElementById('bufferDisplay').textContent = morseBuffer;
            }
            lastTime = now;
            lastState = currentState;
        } else if (!currentState && duration > 600 && morseBuffer !== "") { 
            // If it's been silent for 0.6 seconds, finish the letter
            decodeBuffer();
        }
        requestAnimationFrame(update);
    }

    function decodeBuffer() {
        const char = morseCode[morseBuffer] || "?";
        const output = document.getElementById('output');
        if (output.textContent === "TEXT WILL APPEAR HERE") output.textContent = "";
        output.textContent += char;
        morseBuffer = "";
        document.getElementById('bufferDisplay').textContent = "READY";
    }            }
            lastTime = now;
            lastState = currentState;
        } else if (!currentState && duration > 1000 && morseBuffer !== "") {
            decodeBuffer();
        }
        requestAnimationFrame(update);
    }

    function decodeBuffer() {
        const char = morseCode[morseBuffer] || "?";
        const output = document.getElementById('output');
        if (output.textContent === "TEXT WILL APPEAR HERE") output.textContent = "";
        output.textContent += char;
        morseBuffer = "";
        document.getElementById('bufferDisplay').textContent = "READY";
    }

    // Tone Generator for Sending
    let oscillator;
    function startTone() {
        if (audioContext.state === 'suspended') audioContext.resume();
        oscillator = audioContext.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
        oscillator.connect(audioContext.destination);
        oscillator.start();
    }
    function stopTone() {
        if (oscillator) {
            oscillator.stop();
            oscillator.disconnect();
        }
    }

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js');
    }
</script>

</body>
</html>
